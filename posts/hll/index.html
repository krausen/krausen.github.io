<!doctype html><html lang=en-us><head><title>Compute distinct values in massive datasets with HyperLogLog // Niclas Krause</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.96.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Niclas Krause"><meta name=description content><link rel=stylesheet href=https://krausen.github.io/css/main.min.4a7ec8660f9a44b08c4da97c5f2e31b1192df1d4d0322e65c0dbbc6ecb1b863f.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Compute distinct values in massive datasets with HyperLogLog"><meta name=twitter:description content="HyperLogLog is an approximation algorithm for cardinality (number of unique elements in a set) of a multiset (set that can contain the same element more than once). If you can tolerate to sacrifice some accuracy you can use it to greatly reduce the memory usage of computing the exact cardinality. According to Wikipedia the typical error of accuracy is 2% using 1.5KB of memory for cardinality > 1 billion. This can come in handy if you are working on a very large dataset."><meta property="og:title" content="Compute distinct values in massive datasets with HyperLogLog"><meta property="og:description" content="HyperLogLog is an approximation algorithm for cardinality (number of unique elements in a set) of a multiset (set that can contain the same element more than once). If you can tolerate to sacrifice some accuracy you can use it to greatly reduce the memory usage of computing the exact cardinality. According to Wikipedia the typical error of accuracy is 2% using 1.5KB of memory for cardinality > 1 billion. This can come in handy if you are working on a very large dataset."><meta property="og:type" content="article"><meta property="og:url" content="https://krausen.github.io/posts/hll/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-03T19:19:20+02:00"><meta property="article:modified_time" content="2022-04-03T19:19:20+02:00"></head><body><header class=app-header><a href=https://krausen.github.io><img class=app-header-avatar src=/images/niclas.jpeg alt="Niclas Krause"></a><h1>Niclas Krause</h1><nav class=app-header-menu><a class=app-header-menu-item href=/about>About</a>
-
<a class=app-header-menu-item href=/>Home</a></nav><p>Software developer based in Stockholm, Sweden</p><div class=app-header-social><a href=https://github.com/krausen target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>My Github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Compute distinct values in massive datasets with HyperLogLog</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Apr 3, 2022</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>2 min read</div></div></header><div class=post-content><p>HyperLogLog is an approximation algorithm for cardinality (number of unique elements in a set) of a multiset (set that can contain the same element more than once).
If you can tolerate to sacrifice some accuracy you can use it to greatly reduce the memory usage of computing the exact cardinality. According to <a href=https://en.wikipedia.org/wiki/HyperLogLog>Wikipedia</a> the typical error of accuracy is <strong>2%</strong> using <strong>1.5KB</strong> of memory for cardinality > <strong>1 billion</strong>. This can come in handy if you are working on a very large dataset. Imagine that you want to approximate the number of distinct IP-addresses that have visited your site and the traffic is massive. I wrote some code to simulate this and present the accuracy and memory trade off. To my help I have redis which comes with an implementation of HyperLogLog.</p><h2 id=fake-it-until-you-make-it>Fake it until you make it</h2><p>faker is a nice python library that can help you generate fake data. With the internet provider we can generate loads of public ip addresses.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> faker <span style=color:#f92672>import</span> Faker
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> faker.providers <span style=color:#f92672>import</span> internet
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_generate_fake_ips</span>(n):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Generate a list n of public ips, uniqueness is not guaranteed 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    fake <span style=color:#f92672>=</span> Faker()
</span></span><span style=display:flex><span>    fake<span style=color:#f92672>.</span>add_provider(internet)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    unique_ips <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> range(n):
</span></span><span style=display:flex><span>        unique_ips<span style=color:#f92672>.</span>append(fake<span style=color:#f92672>.</span>ipv4_public())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> unique_ips
</span></span></code></pre></div><h2 id=store-it-in-redis>Store it in redis</h2><p>With redis running as a docker container <code>docker run --rm -d -p 6379:6379 redis</code> we can store it in a HyperLogLog data structure with <strong>PFADD</strong> and to a regular set with <strong>SADD</strong>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> redis
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r <span style=color:#f92672>=</span> redis<span style=color:#f92672>.</span>Redis(host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;localhost&#39;</span>, port<span style=color:#f92672>=</span><span style=color:#ae81ff>6379</span>, db<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HYPERLOGLOG_KEY<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;krausen.github.io:unique_visits_hyperloglog&#34;</span>
</span></span><span style=display:flex><span>SET_KEY<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;krausen.github.io:unique_visits_set&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> ip <span style=color:#f92672>in</span> fake_ips:
</span></span><span style=display:flex><span>   r<span style=color:#f92672>.</span>pfadd(HYPERLOGLOG_KEY, ip)  <span style=color:#75715e># Add ip address to hyperloglog</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> ip <span style=color:#f92672>in</span> fake_ips:
</span></span><span style=display:flex><span>   r<span style=color:#f92672>.</span>sadd(SET_KEY, ip)  <span style=color:#75715e># Add ip to a regular set</span>
</span></span></code></pre></div><p>Similarly we can print cardinality and memory usage with</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>hyperloglog_count <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>pfcount(HYPERLOGLOG_KEY)  <span style=color:#75715e># Get cardinality from hyperloglog</span>
</span></span><span style=display:flex><span>set_count <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>scard(SET_KEY) <span style=color:#75715e># Get cardinality from set</span>
</span></span><span style=display:flex><span>hyperloglog_mem_usage <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>memory_usage(HYPERLOGLOG_KEY) <span style=color:#f92672>/</span> <span style=color:#ae81ff>1024</span> <span style=color:#75715e># Get memory usage from hyperloglog</span>
</span></span><span style=display:flex><span>set_mem_usage <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>memory_usage(SET_KEY) <span style=color:#f92672>/</span> <span style=color:#ae81ff>1024</span>  <span style=color:#75715e># Get memory usage from set</span>
</span></span></code></pre></div><h2 id=results>Results</h2><p>With <strong>10 million</strong> values and a cardinality of <strong>~9.9 million</strong></p><table><thead><tr><th></th><th>Accuracy</th><th>Memory Usage</th></tr></thead><tbody><tr><td>HyperLogLog</td><td>99.89%</td><td>14KB</td></tr><tr><td>Set</td><td>100%</td><td>617725KB</td></tr></tbody></table><p>In this particular case, storing the distinct IP-addresses in a set requires <strong>x44123</strong> memory as the HyperLogLog which gives a good approximation, well within the <strong>2%</strong> error.</p><h2 id=want-more>Want more?</h2><p>For detailed code, check out the repository <a href=https://github.com/krausen/hyperloglog>here</a></p></div><div class=post-footer></div></article></main></body></html>