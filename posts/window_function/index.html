<!doctype html><html lang=en-us><head><title>Window functions in SQL // Niclas Krause</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.96.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Niclas Krause"><meta name=description content><link rel=stylesheet href=https://krausen.github.io/css/main.min.4a7ec8660f9a44b08c4da97c5f2e31b1192df1d4d0322e65c0dbbc6ecb1b863f.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Window functions in SQL"><meta name=twitter:description content="What are window functions anyway? Window function allow to you to do aggregates and calculations on a partition of rows. This can be useful if, for example you want to add a column that shows a cumulative sum over the category that the row belongs to. They can also be used to efficiently remove duplicate rows.
I have an automated setup for populating a PostgreSQL with mock data that can be tested with the queries below."><meta property="og:title" content="Window functions in SQL"><meta property="og:description" content="What are window functions anyway? Window function allow to you to do aggregates and calculations on a partition of rows. This can be useful if, for example you want to add a column that shows a cumulative sum over the category that the row belongs to. They can also be used to efficiently remove duplicate rows.
I have an automated setup for populating a PostgreSQL with mock data that can be tested with the queries below."><meta property="og:type" content="article"><meta property="og:url" content="https://krausen.github.io/posts/window_function/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-05T15:06:26+02:00"><meta property="article:modified_time" content="2022-04-05T15:06:26+02:00"></head><body><header class=app-header><a href=https://krausen.github.io><img class=app-header-avatar src=/images/niclas.jpeg alt="Niclas Krause"></a><h1>Niclas Krause</h1><nav class=app-header-menu><a class=app-header-menu-item href=/about>About</a>
-
<a class=app-header-menu-item href=/>Home</a></nav><p>Software developer based in Stockholm, Sweden</p><div class=app-header-social><a href=https://github.com/krausen target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>My Github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Window functions in SQL</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Apr 5, 2022</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>2 min read</div></div></header><div class=post-content><h2 id=what-are-window-functions-anyway>What are window functions anyway?</h2><p>Window function allow to you to do aggregates and calculations on a partition of rows. This can be useful if, for example you want to add a column that shows a cumulative sum over the category that the row belongs to. They can also be used to efficiently remove duplicate rows.</p><p>I have an <a href=https://github.com/krausen/sql-window-functions>automated setup</a> for populating a PostgreSQL with mock data that can be tested with the queries below. The data is a collection of streamed music songs from a fictional music streaming service containing only the songs from the video game GTA Vice City. Songs don&rsquo;t belong to albums but instead to a radio channel.</p><h2 id=deduplicate-and-keeping-the-latest-ingested-value>Deduplicate and keeping the latest ingested value</h2><p>Partition by event_id which is unique, then select only the first row in each partition.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>COUNT</span>(<span style=color:#f92672>*</span>) 
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> 
</span></span><span style=display:flex><span>    (<span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>,
</span></span><span style=display:flex><span>            ROW_NUMBER() OVER (PARTITION <span style=color:#66d9ef>BY</span> (event_id) <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> ingestion_time <span style=color:#66d9ef>DESC</span>) <span style=color:#66d9ef>AS</span> rn 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> streams) dedup 
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> rn<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>;
</span></span></code></pre></div><h2 id=running-count-for-number-of-streams>Running count for number of streams</h2><p>Compute a running count up until the current row.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    event_id,
</span></span><span style=display:flex><span>    song_name,
</span></span><span style=display:flex><span>    stream_started.
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>COUNT</span>(<span style=color:#f92672>*</span>) OVER (PARTITION <span style=color:#66d9ef>BY</span> song_id <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> stream_started <span style=color:#66d9ef>ROWS</span> <span style=color:#66d9ef>BETWEEN</span> UNBOUNDED
</span></span><span style=display:flex><span>    PRECEDING <span style=color:#66d9ef>and</span> <span style=color:#66d9ef>CURRENT</span> <span style=color:#66d9ef>ROW</span>) <span style=color:#66d9ef>AS</span> running_total_streams
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> streams
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> stream_started;
</span></span></code></pre></div><h2 id=show-previous-and-next-stream-time-for-song-0>Show previous and next stream time for song 0</h2><p>We can look at leading and lagging rows for an individual row.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    event_id,
</span></span><span style=display:flex><span>    song_name,
</span></span><span style=display:flex><span>    stream_started,
</span></span><span style=display:flex><span>    LAG(stream_started, <span style=color:#ae81ff>1</span>) OVER (<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> stream_started) <span style=color:#66d9ef>as</span> previous_stream,
</span></span><span style=display:flex><span>    LEAD(stream_started, <span style=color:#ae81ff>1</span>) OVER (<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> stream_started) <span style=color:#66d9ef>as</span> previous_stream
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> streams
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> song_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span></code></pre></div><h2 id=show-total-number-of-streams-for-the-song-and-the-total-number-of-streams-in-the-channel>Show total number of streams for the song and the total number of streams in the channel</h2><p>Count the number of streams for a song and the total number of streams for all songs in the channel it belongs to.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>    event_id,
</span></span><span style=display:flex><span>    song_name,
</span></span><span style=display:flex><span>    stream_started,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>COUNT</span>(song_id) OVER (PARTITION <span style=color:#66d9ef>BY</span> song_id) <span style=color:#66d9ef>as</span> total_streams_of_this_song, 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>COUNT</span>(song_id) OVER (PARTITION <span style=color:#66d9ef>BY</span> channel) <span style=color:#66d9ef>as</span> total_streams_in_channel
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> streams;
</span></span></code></pre></div><h1 id=top-3-ranked-songs-from-each-channel>Top 3 ranked songs from each channel</h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WITH</span> song_count <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> song_name, <span style=color:#66d9ef>COUNT</span>(song_id) <span style=color:#66d9ef>AS</span> total_streams_on_channel, channel
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> streams
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> song_id, song_name, channel
</span></span><span style=display:flex><span>),
</span></span><span style=display:flex><span>song_rank <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>        song_name,
</span></span><span style=display:flex><span>        channel,
</span></span><span style=display:flex><span>        total_streams_on_channel,
</span></span><span style=display:flex><span>        DENSE_RANK() OVER (PARTITION <span style=color:#66d9ef>BY</span> channel <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> total_streams_on_channel <span style=color:#66d9ef>DESC</span>) <span style=color:#66d9ef>AS</span> rank_on_channel
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> song_count
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> song_rank
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> rank_on_channel <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>3</span>;
</span></span></code></pre></div><h1 id=find-the-most-and-least-streamed-song>Find the most and least streamed song</h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WITH</span> song_count <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> song_name,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>COUNT</span>(song_id) <span style=color:#66d9ef>AS</span> total_streams
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> streams
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> song_id, song_name
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> song_name, total_streams
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span> song_name,
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>MIN</span>(total_streams) OVER() min_streams,
</span></span><span style=display:flex><span>           <span style=color:#66d9ef>MAX</span>(total_streams) OVER() max_streams,
</span></span><span style=display:flex><span>           total_streams
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> song_count
</span></span><span style=display:flex><span>) tmp
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> total_streams <span style=color:#66d9ef>IN</span> (min_streams, max_streams);
</span></span></code></pre></div></div><div class=post-footer></div></article></main></body></html>