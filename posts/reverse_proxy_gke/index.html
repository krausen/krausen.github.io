<!doctype html><html lang=en-us>
<head>
<title>How to setup Nginx as a reverse proxy in GKE // Niclas Krause</title>
<link rel="shortcut icon" href=/favicon.ico>
<meta charset=utf-8>
<meta name=generator content="Hugo 0.88.1">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=author content="Niclas Krause">
<meta name=description content>
<link rel=stylesheet href=https://krausen.github.io/css/main.min.4a7ec8660f9a44b08c4da97c5f2e31b1192df1d4d0322e65c0dbbc6ecb1b863f.css>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="How to setup Nginx as a reverse proxy in GKE">
<meta name=twitter:description content="Before diving in to the specifics of how to set it up in GKE, let&rsquo;s understand what it is we want to achieve and what a reverse proxy is. Put simply, a reverse proxy is a server that redirects clients to the appropriate backend server. The reason for using such an approach are many and here are some:
 Obscure the internal architecture of your backend One DNS record, access all you services from a common URL Load balance by distributing requests to you backend servers Protect against denial of service attacks by enforcing rate limits to your clients SSL encryption can be handled here and ease the load of the application servers  Configure the Nginx First of all we need a configuration for the Nginx that we want to deploy.">
<meta property="og:title" content="How to setup Nginx as a reverse proxy in GKE">
<meta property="og:description" content="Before diving in to the specifics of how to set it up in GKE, let&rsquo;s understand what it is we want to achieve and what a reverse proxy is. Put simply, a reverse proxy is a server that redirects clients to the appropriate backend server. The reason for using such an approach are many and here are some:
 Obscure the internal architecture of your backend One DNS record, access all you services from a common URL Load balance by distributing requests to you backend servers Protect against denial of service attacks by enforcing rate limits to your clients SSL encryption can be handled here and ease the load of the application servers  Configure the Nginx First of all we need a configuration for the Nginx that we want to deploy.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://krausen.github.io/posts/reverse_proxy_gke/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-09-10T15:54:04+02:00">
<meta property="article:modified_time" content="2021-09-10T15:54:04+02:00">
</head>
<body>
<header class=app-header>
<a href=https://krausen.github.io><img class=app-header-avatar src=/images/niclas.jpeg alt="Niclas Krause"></a>
<h1>Niclas Krause</h1>
<nav class=app-header-menu>
<a class=app-header-menu-item href=/about>About</a>
-
<a class=app-header-menu-item href=/>Home</a>
</nav>
<p>Software developer based in Stockholm, Sweden</p>
<div class=app-header-social>
<a href=https://github.com/krausen target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>My Github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a>
</div>
</header>
<main class=app-container>
<article class=post>
<header class=post-header>
<h1 class=post-title>How to setup Nginx as a reverse proxy in GKE</h1>
<div class=post-meta>
<div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
Sep 10, 2021
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
3 min read
</div>
</div>
</header>
<div class=post-content>
<p>Before diving in to the specifics of how to set it up in GKE, let&rsquo;s understand what it is we want to achieve and what a reverse proxy is. Put simply, a reverse proxy is a server that redirects clients to the appropriate backend server. The reason for using such an approach are many and here are some:</p>
<ul>
<li><strong>Obscure</strong> the internal architecture of your backend</li>
<li><strong>One DNS record</strong>, access all you services from a common URL</li>
<li><strong>Load balance</strong> by distributing requests to you backend servers</li>
<li><strong>Protect</strong> against denial of service attacks by enforcing rate limits to your clients</li>
<li><strong>SSL</strong> encryption can be handled here and ease the load of the application servers</li>
</ul>
<h2 id=configure-the-nginx>Configure the Nginx</h2>
<p>First of all we need a configuration for the Nginx that we want to deploy. This is done with the ConfigMap resource, this will allow you to mount the content as a file in the container. Since the proxy will be reachable on the internet we want to encrypt the traffic and only allow HTTPS. In this example we have two services, A and B that are running as separate service in our Kubernetes cluster. To enable the nginx to resolve host names inside the cluster we need to point it towards the internal DNS <code>kube-dns.kube-system.svc.cluster.local</code> .</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx-configmap</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
<span style=color:#f92672>data</span>:
  <span style=color:#f92672>nginx.conf</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>    events {
</span><span style=color:#e6db74>      # This is a required block that is not used</span>    
		}

    <span style=color:#ae81ff>http {</span>
      <span style=color:#ae81ff>server {</span>
        <span style=color:#ae81ff>server_name         &lt;DOMAIN NAME&gt;;</span>
        <span style=color:#ae81ff>ssl_certificate     /etc/ssl/tls.crt;</span>
        <span style=color:#ae81ff>ssl_certificate_key /etc/ssl/tls.key;</span>
        <span style=color:#ae81ff>ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;</span>
        <span style=color:#ae81ff>ssl_ciphers         HIGH:!aNULL:!MD5;</span>
        <span style=color:#ae81ff>resolver            kube-dns.kube-system.svc.cluster.local valid=10s;</span>
        <span style=color:#ae81ff>listen              8443 ssl;</span>
        <span style=color:#ae81ff>error_log           /var/log/nginx/error.log;</span>
        <span style=color:#ae81ff>access_log          /var/log/nginx/access.log;</span>

        <span style=color:#ae81ff>location ^~ /service_a  {</span>
          <span style=color:#ae81ff>set $internal_service_a &lt;SERVICE NAME A&gt;.&lt;NAMESPACE&gt;.svc.cluster.local:&lt;SERVICE A PORT&gt;;</span>
          <span style=color:#ae81ff>proxy_set_header Host $host;</span>
          <span style=color:#ae81ff>proxy_pass http://${internal_service_a};</span>
        }

        <span style=color:#ae81ff>location ^~ /service_b  {</span>
          <span style=color:#ae81ff>set $internal_service_b &lt;SERVICE NAME B&gt;.&lt;NAMESPACE&gt;.svc.cluster.local:&lt;SERVICE B PORT&gt;;</span>
          <span style=color:#ae81ff>proxy_set_header Host $host;</span>
          <span style=color:#ae81ff>proxy_pass http://${internal_service_b};</span>
        }

        <span style=color:#ae81ff>location ^~ /health {</span>
          <span style=color:#ae81ff>access_log off;</span>
          <span style=color:#ae81ff>return 200 &#34;I am well, thank you very much!\n&#34;;</span>
          <span style=color:#ae81ff>add_header Content-Type text/plain;</span>
        }
      }
    }
</code></pre></div><h2 id=deploy-the-nginx>Deploy the Nginx</h2>
<p>Next we need to create the deployment of the Nginx, notice here that we mount the ConfigMap and secrets to the container. We have not created a secret yet, but we will get to that in a bit. We are exposing port <strong>8443</strong> of the container internally.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>---
<span style=color:#f92672>apiVersion</span>: <span style=color:#e6db74>&#34;apps/v1&#34;</span>
<span style=color:#f92672>kind</span>: <span style=color:#e6db74>&#34;Deployment&#34;</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;reverse-proxy&#34;</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>default</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>app</span>: <span style=color:#e6db74>&#34;reverse-proxy&#34;</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>matchLabels</span>:
      <span style=color:#f92672>app</span>: <span style=color:#e6db74>&#34;reverse-proxy&#34;</span>
  <span style=color:#f92672>template</span>:
    <span style=color:#f92672>metadata</span>:
      <span style=color:#f92672>labels</span>:
        <span style=color:#f92672>app</span>: <span style=color:#e6db74>&#34;reverse-proxy&#34;</span>
    <span style=color:#f92672>spec</span>:
      <span style=color:#f92672>containers</span>:
        - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;reverse-proxy&#34;</span>
          <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#34;nginx:latest&#34;</span>
          <span style=color:#f92672>volumeMounts</span>:
            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx-volume</span>
              <span style=color:#f92672>mountPath</span>: <span style=color:#e6db74>&#34;/etc/nginx&#34;</span>
              <span style=color:#f92672>readOnly</span>: <span style=color:#66d9ef>true</span>
            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx-cert</span>
              <span style=color:#f92672>mountPath</span>: <span style=color:#e6db74>&#34;/etc/ssl&#34;</span>
              <span style=color:#f92672>readOnly</span>: <span style=color:#66d9ef>true</span>
          <span style=color:#f92672>ports</span>:
            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8443</span>
          <span style=color:#f92672>livenessProbe</span>:
             <span style=color:#f92672>httpGet</span>:
               <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/health</span>
               <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8443</span>
      <span style=color:#f92672>volumes</span>:
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx-volume</span>
          <span style=color:#f92672>configMap</span>:
            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx-configmap</span>
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx-cert</span>
          <span style=color:#f92672>secret</span>:
            <span style=color:#f92672>secretName</span>: <span style=color:#ae81ff>reverse-proxy-cert</span>
</code></pre></div><h2 id=create-the-secret>Create the secret</h2>
<p>Before we can actually deploy the service we need the certificate and the private key. Creating the actual files is beyond the scope of this post. But given that you have them the command to upload them to k8s is:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f nginx.yml
</code></pre></div><h2 id=expose-it>Expose it!</h2>
<p>Next we need to expose the service on the internet, this is achieved by creating a LoadBalancer service. This will implicitly create a TCP Network LoadBalancer that forwards the TCP traffic to your Nginx service in k8s.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>reverse-proxy-svc</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>deafult</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>LoadBalancer</span>
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>reverse-proxy</span>
  <span style=color:#f92672>ports</span>:
  - <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
    <span style=color:#f92672>port</span>: <span style=color:#ae81ff>443</span>
    <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>8443</span>
</code></pre></div><p>The IP address of the LoadBalanceris created automatically as an ephemeral address. To make sure that it stays static we need to navigate in the console to <strong>VPC Networks > External IP addresses.</strong> To the far right of the IP address row you will find the button <strong>Reserve</strong> that will make the address static. Take note of the IP address and update your DNS records.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl create secret tls reverse-proxy-cert --cert<span style=color:#f92672>=</span>./&lt;DOMAIN NAME&gt;.crt --key<span style=color:#f92672>=</span>./&lt;DOMAIN NAME&gt;.key --namespace<span style=color:#f92672>=</span>default
</code></pre></div>
</div>
<div class=post-footer>
</div>
</article>
</main>
</body>
</html>